# 🤖 ربات ساخت استیکر متنی

این ربات برای ساخت استیکرهای متنی فارسی و انگلیسی در تلگرام طراحی شده است.

## 🔧 مشکلات حل شده

### 1. مشکل فایل‌های بزرگ
- **مشکل**: وقتی کاربران عکس‌های بزرگ ارسال می‌کردند، ربات خطای "file is too big" می‌داد
- **راه‌حل**: 
  - بررسی حجم فایل قبل از دانلود (حداکثر 20MB)
  - فشرده‌سازی خودکار تصاویر بزرگ
  - تغییر اندازه تصاویر بزرگتر از 2048 پیکسل
  - تنظیم کیفیت بر اساس حجم فایل (75-90%)

### 2. مشکل اسم پک تکراری
- **مشکل**: ربات اسم پک همه کاربران را ذخیره می‌کرد و تداخل ایجاد می‌شد
- **راه‌حل**:
  - اضافه کردن شناسه کاربر به نام پک: `{pack_name}_{user_id}_by_{bot_username}`
  - سیستم شماره‌گذاری خودکار در صورت تداخل
  - محدودیت طول نام پک (64 کاراکتر)

### 3. بهبود ذخیره‌سازی داده‌ها
- **قبل**: داده‌ها در حافظه نگهداری می‌شدند
- **بعد**: سیستم مدیریت دیتابیس با فایل‌های JSON جداگانه:
  - `users.json` - اطلاعات کاربران
  - `subscriptions.json` - اشتراک‌ها
  - `user_packs.json` - پک‌های استیکر کاربران
  - `pending_payments.json` - پرداخت‌های در انتظار
  - `feedback_data.json` - بازخوردهای کاربران
  - `bot_settings.json` - تنظیمات ربات

## 📁 ساختار فایل‌ها

```
sticker bot/
├── bot.py                 # فایل اصلی ربات
├── database_manager.py    # مدیریت دیتابیس
├── README.md             # راهنمای استفاده
├── users.json            # داده‌های کاربران
├── subscriptions.json    # اطلاعات اشتراک‌ها
├── user_packs.json       # پک‌های استیکر کاربران
├── pending_payments.json # پرداخت‌های در انتظار
├── feedback_data.json    # بازخوردهای کاربران
├── bot_settings.json     # تنظیمات ربات
└── fonts/               # فونت‌های فارسی و انگلیسی
    ├── Vazirmatn-Regular.ttf
    ├── IRANSans.ttf
    └── arial.ttf
```

## 🚀 نصب و راه‌اندازی

### 1. نصب کتابخانه‌ها
```bash
pip install flask requests pillow waitress arabic-reshaper python-bidi
```

### 2. تنظیم متغیرهای محیطی
```bash
export BOT_TOKEN="your_bot_token_here"
export APP_URL="https://your-app-url.com"
export BOT_USERNAME="your_bot_username"
export CHANNEL_LINK="@your_channel"
export CARD_NUMBER="1234-5678-9012-3456"
export CARD_NAME="نام صاحب کارت"
```

### 3. اجرای ربات
```bash
python bot.py
```

## 🔧 استفاده از DatabaseManager

```python
from database_manager import DatabaseManager

# ایجاد نمونه
db = DatabaseManager("./data")

# کار با کاربران
user_data = db.get_user_data(user_id)
db.set_user_data(user_id, {"name": "علی", "lang": "fa"})

# کار با اشتراک‌ها
if db.is_subscribed(user_id):
    print("کاربر اشتراک فعال دارد")

# اضافه کردن پک جدید
db.add_user_pack(user_id, {
    "name": "my_pack_123_by_bot",
    "title": "پک من",
    "sticker_count": 1
})

# دریافت آمار
stats = db.get_stats()
print(f"تعداد کاربران: {stats['total_users']}")
```

## 📊 ویژگی‌های جدید

### 1. مدیریت حجم فایل
- بررسی حجم قبل از دانلود
- فشرده‌سازی خودکار
- پیام‌های راهنما برای کاربران

### 2. مدیریت پک‌های استیکر
- نام‌گذاری منحصر به فرد برای هر کاربر
- ردیابی تعداد استیکرها در هر پک
- تاریخچه پک‌های ساخته شده

### 3. سیستم بازخورد
- ذخیره نظرات مثبت و منفی
- آمار رضایت کاربران
- بهبود مستمر بر اساس بازخورد

### 4. پشتیبان‌گیری خودکار
- پشتیبان‌گیری روزانه از داده‌ها
- حذف خودکار پشتیبان‌های قدیمی
- بازیابی آسان در صورت مشکل

## 🛠️ عیب‌یابی

### مشکلات رایج:

1. **خطای "file is too big"**
   - بررسی کنید حجم عکس کمتر از 20MB باشد
   - از کیفیت کمتر برای عکس استفاده کنید

2. **خطای فونت**
   - فونت‌های فارسی را در پوشه `fonts/` قرار دهید
   - مطمئن شوید فایل‌های فونت خراب نیستند

3. **خطای دیتابیس**
   - بررسی کنید پوشه `data/` قابل نوشتن باشد
   - فایل‌های JSON را بررسی کنید

## 📞 پشتیبانی

برای مشکلات فنی:
- بررسی لاگ‌های ربات
- استفاده از دستور `/admin system` برای بررسی وضعیت
- تماس با پشتیبانی

## 📈 آمار و گزارش‌گیری

دستورات ادمین:
- `/admin stats` - آمار کلی
- `/admin list` - لیست کاربران اشتراکی
- `/admin payments` - پرداخت‌های در انتظار
- `/admin feedback` - بازخوردهای کاربران
- `/admin system` - وضعیت سیستم

## 🔄 به‌روزرسانی

برای به‌روزرسانی ربات:
1. پشتیبان‌گیری از داده‌ها
2. دانلود نسخه جدید
3. بازیابی داده‌ها
4. راه‌اندازی مجدد

---

**نکته**: این ربات برای استفاده شخصی و تجاری طراحی شده و قابلیت مقیاس‌پذیری دارد.
